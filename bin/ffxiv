#!/usr/bin/env bash
WINE=$(command -v wine)
# export WINEARCH=win32
export WINEPREFIX="$HOME/.local/share/wineprefixes/ffxiv"
export WINEDEBUG=-all

LAUNCHER="C://Program Files (x86)//SquareEnix//FINAL FANTASY XIV - A Realm Reborn//boot//ffxivboot.exe"
PYLAUNCHER="$WINEPREFIX/drive_c/Program Files (x86)/SquareEnix/FINAL FANTASY XIV - A Realm Reborn/launcher.py"

# export LD_PRELOAD="libpthread.so.0 libGL.so.1"
# export __GL_THREADED_OPTIMISATIONS=1
# export mesa_glthread=true

# export __GL_SYNC_TO_VBLANK=1
# export __GL_SYNC_DISPLAY_DEVICE="DFP-0"

# export STAGING_WRITECOPY=1
# export STAGING_SHARED_MEMORY=1

case "$1" in
    # TODO: Edit ~/.wine-ffxiv/drive_c/users/$USER/My Documents/My Games/FINAL FANTASY XIV - A Realm Reborn/FFXIV_BOOT.CFG
    #         Change BrowserType 0 to BrowserType 2
    #       Edit ~/.wine-ffxiv/drive_c/users/$USER/My Documents/My Games/FINAL FANTASY XIV - A Realm Reborn /FFXIV.cfg
    #         Change CutsceneMovieOpening 0 to CutsceneMovieOpening 1
    install)
        INSTALLER_URL='http://gdl.square-enix.com/ffxiv/inst/ffxivsetup.exe'
        INSTALLER_MD5='5849526a5ee3077818e46daaa34de6dc'

        INSTALLER="$HOME/.cache/ffxivsetup.exe"

        ## Do not overwrite prefix. Run reset first.
        if [[ -d "$WINEPREFIX" ]]; then
            echo "Destination $WINEPREFIX exists. Aborting. Run $(basename "$0") reset."
            exit 1
        fi

        winetricks xact quartz
        wineserver -w
        setup_dxvk64

        if [[ ! -f "$INSTALLER" ]]; then
            curl -o "$INSTALLER" -L "$INSTALLER_URL"
        fi

        if [[ -f "$INSTALLER" ]]; then
            MD5=$(md5sum "$INSTALLER")
            if [[ "$MD5" = "$INSTALLER_MD5  $INSTALLER" ]]; then
                "$WINE" "$INSTALLER"
            else
                echo "Installer did not pass md5 check. Removing and downloading again."
                echo "Expected md5: $INSTALLER_MD5"
                echo "Obtained m5: $MD5"

                rm "$INSTALLER"
                curl -o "$INSTALLER" -L "$INSTALLER_URL"
                MD5=$(md5sum "$INSTALLER")
                if [[ "$MD5" = "$INSTALLER_MD5  $INSTALLER" ]]; then
                    "$WINE" "$INSTALLER"
                else
                    echo "Downloaded installer again, still did not pass md5 check. Aborting."
                    echo "Expected md5: $INSTALLER_MD5"
                    echo "Obtained m5: $MD5"
                fi
            fi
        else
            echo "The installation file could not be found at $INSTALLER"
        fi
        ;;

    reset)
        echo "this will completely remove $WINEPREFIX. This can not be undone."
        read -p "Are you sure? " -n 1 -r

        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo
            echo -n "Nuking wineprefix... "
            rm -rf "$WINEPREFIX"
            echo "Done."
        else
            echo "Aborting."
        fi
        ;;

    version)
        echo "Wine path: ${WINE%%/bin/wine}"
        echo "Wine version: $($WINE --version)"
        ;;

    config)
        exec "${WINE%/*}/winecfg"
        ;;

    winetricks)
        shift
        exec winetricks "$@"
        ;;

    kill)
        pkill -f -KILL "windows|wineserver|wineconsole|awesomium|winetricks|winedbg|explorer.exe|final fantasy|ffxiv"
        ;;

    syswine)
        exec /usr/bin/wine "$LAUNCHER"
        ;;

    run)
        shift
        exec "$WINE" "$@"
        ;;

    *)
        exec "$WINE" "$LAUNCHER"
        ;;

esac
