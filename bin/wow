#!/usr/bin/env bash
WINE=$(command -v wine)

export WINE

# LAUNCHPAD="C://Program Files/World of Warcraft/World of Warcraft Launcher.exe"
LAUNCHPAD="C://Program Files/Battle.net/Battle.net Launcher.exe"

export WINEARCH=win32
export WINEPREFIX="$HOME/.local/share/wineprefixes/wow"
# export WINEDEBUG=-all

# export LD_PRELOAD="libpthread.so.0 libGL.so.1"
# export __GL_THREADED_OPTIMISATIONS=1

# export __GL_SYNC_TO_VBLANK=1
# export __GL_SYNC_DISPLAY_DEVICE="DFP-0"

# export STAGING_WRITECOPY=1
# export STAGING_SHARED_MEMORY=1

case "$1" in
		install)
				INSTALLER_URL='https://www.battle.net/download/getInstallerForGame?os=win&locale=enGB&version=LIVE&gameProgram=WOW'
				INSTALLER_MD5='6ac1f1fced3660718a9fff0c1b707e95'

				INSTALLER="$HOME/.cache/World-of-Warcraft-Setup.exe"

				## Do not overwrite prefix. Run reset first.
				if [[ -d "$WINEPREFIX" ]]; then
						progname=$(basename "$0")
						echo "Destination $WINEPREFIX exists. Aborting. Run $progname reset."
						exit 1
				fi

				winetricks corefonts vcrun2015 winhttp wininet dxvk winxp
        # wineserver -w

				if [[ ! -f "$INSTALLER" ]]; then
						curl -o "$INSTALLER" -L "$INSTALLER_URL"
				fi

				if [[ -f "$INSTALLER" ]]; then
						MD5=$(md5sum "$INSTALLER")
						if [[ "$MD5" = "$INSTALLER_MD5  $INSTALLER" ]]; then
								"$WINE" "$INSTALLER"
						else
								echo "Installer did not pass md5 check. Removing and downloading again."
								echo "Expected md5: $INSTALLER_MD5"
								echo "Obtained m5: $MD5"

								rm "$INSTALLER"
								curl -o "$INSTALLER" -L "$INSTALLER_URL"
								MD5=$(md5sum "$INSTALLER")
								if [[ "$MD5" = "$INSTALLER_MD5  $INSTALLER" ]]; then
										"$WINE" "$INSTALLER"
								else
										echo "Downloaded installer again, still did not pass md5 check. Aborting."
										echo "Expected md5: $INSTALLER_MD5"
										echo "Obtained m5: $MD5"
								fi
						fi
				else
						echo "The installation file could not be found at $INSTALLER"
				fi
				;;

		reset)
				echo "this will completely remove $WINEPREFIX. This can not be undone."
				read -p "Are you sure? " -n 1 -r

				if [[ $REPLY =~ ^[Yy]$ ]]; then
						echo
						echo -n "Nuking wineprefix... "
						rm -rf "$WINEPREFIX"
						echo "Done."
				else
						echo "Aborting."
				fi
				;;

		version)
				echo "Wine path: ${WINE%%/bin/wine}"
				echo "Wine version: $($WINE --version)"
				;;

		config)
				exec "${WINE%/*}/winecfg"
				;;

		winetricks)
				shift
				exec winetricks "$@"
				;;

		kill)
						pkill -f -KILL "windows|wineserver|wow|warcraft|battle.net|wineconsole|awesomium|winetricks|winedbg|explorer.exe"
				;;

		syswine)
				exec /usr/bin/wine "$LAUNCHPAD"
				;;

		run)
				shift
				exec "$WINE" "$@"
				;;

		*)
				exec "$WINE" explorer /desktop=wow,3840x2117 "$LAUNCHPAD"
				;;

esac
