#!/usr/bin/env zsh

rec="$HOME/.cache/screencast-$(date +%Y%m%d-%H%M).rec.mkv"

function record() {
	ffmpeg -v info\
		-f x11grab -s 3840x2160 -i :0.0+3840,0 \
		-f pulse -i "alsa_output.pci-0000_0d_00.3.analog-stereo.monitor"\
		-f pulse -i "alsa_input.usb-BLUE_MICROPHONE_Blue_Snowball_201306-00.analog-mono"\
		-vcodec libx264 -preset ultrafast -tune zerolatency -crf 0\
		-acodec pcm_s16le -strict -2\
		-filter_complex 'amerge, pan=2c| c0=0.3*c0+3*c2 | c1=0.3*c1+3*c2'\
		"$rec"
}

function recompress() {
	[[ ! -r "$1" ]] && echo "File not found or not readable: $1." && return 127

	## Mux to video
	fp="${1%.*}.recomp.mkv"
	[[ -f $fp ]] && mv -f "$fp" "${fp}.bak"
	# This is gonna take a while
	ffmpeg -i $1 -vcodec libx264 -crf 19 -preset veryslow -tune film -acodec flac -strict -2 $fp

}

case $1 in
	recompress)
		recompress $2
		;;
	record)
		record $2
		;;
	*)
		echo "Usage: $0 [record|recompress]"
		;;
esac
