#!/usr/bin/env bash

export WINE=$(command -v wine)

LAUNCHER='C://Program Files/Guild Wars 2/Gw2.exe'

export WINEARCH=win32
export WINEPREFIX="$HOME/.local/share/wineprefixes/gw2"
export WINEDEBUG=-all

# export LD_PRELOAD="libpthread.so.0 libGL.so.1"
# export __GL_THREADED_OPTIMISATIONS=1
export mesa_glthread=true

# export __GL_SYNC_TO_VBLANK=1
# export __GL_SYNC_DISPLAY_DEVICE="DFP-0"

# export STAGING_WRITECOPY=1
# export STAGING_SHARED_MEMORY=1

case "$1" in
		install)
        # 64bit
        # INSTALLER_URL='http://s3.amazonaws.com/gw2cdn/client/branches/Gw2Setup-64.exe'
				# INSTALLER_MD5='66a58815053e092960c0b08c209e1a71'

        # 32bit
        INSTALLER_URL='http://s3.amazonaws.com/gw2cdn/client/branches/Gw2Setup.exe'
				INSTALLER_MD5='0a2cb014408af45e5572d74a85be2d96'

				INSTALLER="$HOME/.cache/Gw2Setup.exe"

				## Do not overwrite prefix. Run reset first.
				if [[ -d "$WINEPREFIX" ]]; then
						progname=$(basename "$0")
						echo "Destination $WINEPREFIX exists. Aborting. Run $progname reset."
						exit 1
				fi

				# winetricks corefonts vcrun2015

				## "Reboot" wine
				# ${WINE%/*}/wineboot
        wineserver -w

				if [[ ! -f "$INSTALLER" ]]; then
						curl -o "$INSTALLER" -L "$INSTALLER_URL"
				fi

				if [[ -f "$INSTALLER" ]]; then
						MD5=$(md5sum "$INSTALLER")
						if [[ "$MD5" = "$INSTALLER_MD5  $INSTALLER" ]]; then
								"$WINE" "$INSTALLER"
						else
								echo "Installer did not pass md5 check. Removing and downloading again."
								echo "Expected md5: $INSTALLER_MD5"
								echo "Obtained m5: $MD5"

								rm "$INSTALLER"
								curl -o "$INSTALLER" -L "$INSTALLER_URL"
								MD5=$(md5sum "$INSTALLER")
								if [[ "$MD5" = "$INSTALLER_MD5  $INSTALLER" ]]; then
										"$WINE" "$INSTALLER"
								else
										echo "Downloaded installer again, still did not pass md5 check. Aborting."
										echo "Expected md5: $INSTALLER_MD5"
										echo "Obtained m5: $MD5"
								fi
						fi
				else
						echo "The installation file could not be found at $INSTALLER"
				fi
				;;

		reset)
				echo "this will completely remove $WINEPREFIX. This can not be undone."
				read -p "Are you sure? " -n 1 -r

				if [[ $REPLY =~ ^[Yy]$ ]]; then
						echo
						echo -n "Nuking wineprefix... "
						rm -rf "$WINEPREFIX"
						echo "Done."
				else
						echo "Aborting."
				fi
				;;

		version)
				echo "Wine path: ${WINE%%/bin/wine}"
				echo "Wine version: $($WINE --version)"
				;;

		config)
				exec "${WINE%/*}/winecfg"
				;;

		winetricks)
				shift
				exec winetricks "$@"
				;;

		kill)
						pkill -f -KILL "windows|wineserver|guildwars|wineconsole|awesomium|winetricks|winedbg|explorer.exe"
				;;

		syswine)
				exec /usr/bin/wine "$LAUNCHER"
				;;

		run)
				shift
				exec "$WINE" "$@"
				;;

		*)
				exec "$WINE" explorer /desktop=gw2,1920x1058 "$LAUNCHER"
				;;

esac
