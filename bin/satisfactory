#!/usr/bin/env bash

set -euo pipefail

WINE="$(command -v wine)"
export WINE
export WINEPREFIX="$HOME/.local/share/wineprefixes/satisfactory"
export WINEDEBUG=-all
export WINEESYNC=1

GAME='C://satisfactory/FactoryGame.exe'

case "${1:-default}" in
    install)
        BASEPATH="$WINEPREFIX/drive_c/satisfactory"
        INSTALLER="$HOME/media/inbox/torrents/Satisfactory (Early Access 96032)"

        # Do not overwrite prefix. Run reset first.
        if [[ -d "$WINEPREFIX" ]]; then
            echo "Destination $WINEPREFIX exists. Aborting. Run $(basename "$0") reset."
            exit 1
        fi

        winetricks -q win10 corefonts xact d3dx9_36

        set -x
        rsync -azv "$INSTALLER/" "$BASEPATH/"

        pushd "$BASEPATH"
        "$WINE" 'Satisfactory-Update-96463.exe' || true
        "$WINE" 'Satisfactory-Update-96731.exe' || true
        popd

        set +x
        ;;

    reset)
        echo "this will completely remove $WINEPREFIX. This can not be undone."
        read -p "Are you sure? " -n 1 -r

        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo
            echo -n "Nuking wineprefix... "
            rm -rf "$WINEPREFIX"
            echo "Done."
        else
            echo "Aborting."
        fi
        ;;

    version)
        echo "Wine path: ${WINE%%/bin/wine}"
        echo "Wine version: $($WINE --version)"
        ;;

    config)
        exec "${WINE%/*}/winecfg"
        ;;

    winetricks)
        shift
        exec winetricks "$@"
        ;;

    kill)
        pkill -fi -KILL "windows|wineserver|wineconsole|awesomium|winetricks|winedbg|explorer.exe|satisfactory|factory|epic"
        ;;

    run)
        shift
        exec "$WINE" "$@"
        ;;

    default)
        exec "$WINE" "$GAME" -EpicPortal
        ;;

    *)
        echo 'Unknown command'
        ;;
esac

# vim:ft=sh
