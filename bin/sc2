#!/usr/bin/env bash

# shellcheck disable=SC2155
export WINEPREFIX="$HOME/.local/share/wineprefixes/$(basename "$0")"
export WINEDEBUG='-all'
export WINEESYNC=1
export WINE='/opt/wine-tkg-opt-git/bin/wine'

# export GALLIUM_HUD='fps'
# export DXVK_HUD='devinfo,fps,version'
export DXVK_STATE_CACHE_PATH="$WINEPREFIX"
export PULSE_LATENCY_MSEC=60
export __GL_SHADER_DISK_CACHE=1
export __GL_SHADER_DISK_CACHE_PATH="$WINEPREFIX"

export SC2="C://Program Files (x86)/StarCraft II/Support64/SC2Switcher_x64.exe"
export LAUNCHPAD="C://Program Files (x86)/Battle.net/Battle.net Launcher.exe"

case "$1" in
    install)
        INSTALLER_URL='https://www.battle.net/download/getInstallerForGame?os=win&locale=enUS&version=LIVE&gameProgram=STARCRAFT_2'
        INSTALLER_MD5='a78068e83bd05f1413f45c0ee75ba479'

        INSTALLER="$HOME/.cache/sc2_setup.exe"

        ## Do not overwrite prefix. Run reset first.
        if [[ -d "$WINEPREFIX" ]]; then
            echo "Destination $WINEPREFIX exists. Aborting. Run $(basename "$0") reset."
            exit 1
        fi

        # d9vk won't work until mesa 19.1
        winetricks -q win10 d3dcompiler_43 d3dcompiler_47 galliumnine

        if [[ ! -f "$INSTALLER" ]]; then
            curl -o "$INSTALLER" -L "$INSTALLER_URL"
        fi

        if [[ -f "$INSTALLER" ]]; then
            MD5=$(md5sum "$INSTALLER")
            if [[ "$MD5" = "$INSTALLER_MD5  $INSTALLER" ]]; then
                "$WINE" "$INSTALLER"
            else
                echo "Installer did not pass md5 check. Removing and downloading again."
                echo "Expected md5: $INSTALLER_MD5"
                echo "Obtained m5: $MD5"

                rm "$INSTALLER"
                curl -o "$INSTALLER" -L "$INSTALLER_URL"
                MD5=$(md5sum "$INSTALLER")
                if [[ "$MD5" = "$INSTALLER_MD5  $INSTALLER" ]]; then
                    "$WINE" "$INSTALLER"
                else
                    echo "Downloaded installer again, still did not pass md5 check. Aborting."
                    echo "Expected md5: $INSTALLER_MD5"
                    echo "Obtained m5: $MD5"
                fi
            fi
        else
            echo "The installation file could not be found at $INSTALLER"
        fi
        ;;

    reset)
        echo "this will completely remove $WINEPREFIX. This can not be undone."
        read -p "Are you sure? " -n 1 -r

        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo
            echo -n "Nuking wineprefix... "
            rm -rf "$WINEPREFIX"
            echo "Done."
        else
            echo "Aborting."
        fi
        ;;

    version)
        echo "Wine path: ${WINE%%/bin/wine}"
        echo "Wine version: $($WINE --version)"
        ;;

    config)
        exec "${WINE%/*}/winecfg"
        ;;

    winetricks)
        shift
        exec winetricks "$@"
        ;;

    kill)
        # shellcheck disable=SC2009
        ps ux | grep -v grep | grep -v "sc2 kill\\|qutebrowser\\|firefox\\|chrome\\|chromium" | \
            grep -i "windows\\|wineserver\\|sc2\\|starcraft\\|.exe\\|battle.net\\|wineconsole\\|awesomium\\|winetricks\\|winedbg\\|explorer.exe" | \
            awk '{print $2}' | xargs kill -KILL
        ;;

    run)
        shift
        exec "$WINE" "$@"
        ;;

    launcher)
        exec "$WINE" "$LAUNCHPAD"
        ;;

    *)
        exec "$WINE" "$SC2"
        ;;

esac

# vim:ft=sh
